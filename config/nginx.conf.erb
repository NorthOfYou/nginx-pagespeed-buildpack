daemon off;
worker_processes <%= ENV['NGINX_WORKERS'] || 4 %>;

events {
	use epoll;
	accept_mutex on;
	worker_connections <%= ENV['NGINX_WORKER_CONNECTIONS'] || 1024 %>;
}

http {
    gzip on;
    gzip_comp_level 6;
    gzip_min_length 512;
	gzip_vary on;
	gzip_proxied any;
	gzip_types
		text/plain
		text/html
		text/css
		application/json
		application/javascript
		text/xml
		application/xml
		application/xml+rss
		text/javascript
		image/svg+xml;

	server_tokens off;

	log_format l2met 'measure#nginx.service=$request_time request_id=$http_x_request_id';
	access_log <%= ENV['NGINX_ACCESS_LOG_PATH'] || 'logs/nginx/access.log' %> l2met;
	error_log <%= ENV['NGINX_ERROR_LOG_PATH'] || 'logs/nginx/error.log' %>;

	include mime.types;
	default_type application/octet-stream;
	sendfile on;

	client_body_timeout <%= ENV['NGINX_CLIENT_BODY_TIMEOUT'] || 5 %>;

	upstream app_server {
		server unix:/tmp/nginx.socket fail_timeout=0;
 	}

	server {
		listen <%= ENV["PORT"] %>;
		server_name _;
		keepalive_timeout 5;
		# client_max_body_size <%= ENV['NGINX_CLIENT_MAX_BODY_SIZE'] || 1 %>M;

		location / {
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header Host $http_host;
			proxy_redirect off;
			proxy_pass http://app_server;
		}

		location ^~ /blog {
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header Host $http_host;
			proxy_set_header X-NginX-Proxy true;
			proxy_pass http://104.236.26.219:2368/blog;
			proxy_redirect off;
		}

		pagespeed on;
		pagespeed Statistics on;
		pagespeed StatisticsLogging on;
		pagespeed LogDir /app/log/pagespeed;
		pagespeed FileCachePath /app/var/ngx_pagespeed_cache;
		pagespeed EnableCachePurge on;
		pagespeed FetchHttps enable;

		pagespeed Domain https://witharsenal.com;
		pagespeed Domain https://witharsenal-pr-38.herokuapp.com;
		pagespeed Domain https://d288blwc9kbrw2.cloudfront.net;

		pagespeed RewriteLevel CoreFilters;
		pagespeed EnableFilters responsive_images;
		pagespeed EnableFilters inline_images;
		pagespeed EnableFilters resize_images;
		pagespeed EnableFilters rewrite_style_attributes_with_url;
		pagespeed EnableFilters rewrite_css;
		pagespeed EnableFilters prioritize_critical_css;
		pagespeed EnableFilters make_google_analytics_async;
		pagespeed EnableFilters inline_google_font_css;
		pagespeed EnableFilters local_storage_cache;
		pagespeed EnableFilters inline_preview_images;
		pagespeed EnableFilters resize_mobile_images;
		pagespeed EnableFilters remove_comments;
		pagespeed EnableFilters collapse_whitespace;
		pagespeed EnableFilters elide_attributes;
		pagespeed EnableFilters add_instrumentation;
		pagespeed EnableFilters defer_javascript;
		pagespeed EnableFilters in_place_optimize_for_browser;
		pagespeed EnableFilters lazyload_images;
		
		location ~ "\.pagespeed\.([a-z]\.)?[a-z]{2}\.[^.]{10}\.[^.]+" {
			add_header "" "";
		}
		location ~ "^/pagespeed_static/" { }
		location ~ "^/ngx_pagespeed_beacon$" { }
		
		pagespeed AdminPath /pagespeed_admin_RgYrNHmLRPef;
		location ~ ^/pagespeed_admin_RgYrNHmLRPef {
		  allow all;
		}
	}
}
